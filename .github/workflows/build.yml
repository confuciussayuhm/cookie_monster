name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Download Burp Suite JAR
      run: |
        echo "Downloading Burp Suite Community Edition..."
        # Download the latest Burp Suite JAR (adjust URL as needed)
        wget -q "https://portswigger.net/burp/releases/download?product=community&type=jar" -O burpsuite.jar || true

        # Extract Montoya API classes if jar was downloaded successfully
        if [ -f burpsuite.jar ]; then
          echo "Extracting Montoya API classes..."
          unzip -q burpsuite.jar "burp/api/montoya/*" -d burp-api 2>/dev/null || true

          # If extraction succeeded, compile the API
          if [ -d burp-api/burp ]; then
            echo "Compiling Montoya API..."
            mkdir -p target/classes
            find burp-api/burp -name "*.class" -exec cp --parents {} target/classes/ \;
          fi
        fi

    - name: Build with Maven (compile only)
      run: |
        echo "Compiling extension classes..."
        mkdir -p target/classes

        # Compile our extension classes against the extracted API
        javac -cp target/classes -d target/classes src/main/java/burp/cookiemonster/*.java

        # Create JAR
        cd target/classes
        jar cvf ../cookie-monster.jar burp/cookiemonster/*.class
        cd ../..

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: cookie-monster-jar
        path: target/cookie-monster.jar
        retention-days: 30

    - name: Display build info
      run: |
        echo "Build completed successfully!"
        ls -lh target/cookie-monster.jar
